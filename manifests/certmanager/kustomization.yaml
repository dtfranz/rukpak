resources:
- ../base
- resources/webhook
- resources/core
- resources/crdvalidator
- resources/provisioners

patches:
- target: 
    group: admissionregistration.k8s.io
    version: v1
    kind: ValidatingWebhookConfiguration
    name: validating-webhook-configuration
  path: patches/cainjection.yaml

replacements:
- source: # replaces CERTIFICATE_NAMESPACE with namespace of the certificate CR
    kind: Certificate
    group: cert-manager.io
    version: v1
    name: webhook-certificate # this name should match the one in certificate.yaml
    fieldPath: metadata.namespace
  targets:
  - select:
      kind: ValidatingWebhookConfiguration
      name: validating-webhook-configuration
    fieldPaths: 
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 0
- source: # replaces CERTIFICATE_NAME with name of the certificate CR
    kind: Certificate
    group: cert-manager.io
    version: v1
    name: webhook-certificate # this name should match the one in certificate.yaml
    fieldPath: metadata.name
  targets:
  - select:
      kind: ValidatingWebhookConfiguration
      name: validating-webhook-configuration
    fieldPaths: 
    - metadata.annotations.[cert-manager.io/inject-ca-from]
    options:
      delimiter: /
      index: 1
- source: # replaces SERVICE_NAMESPACE with namespace of the service
    kind: Service
    version: v1
    name: webhook-service
    fieldPath: metadata.namespace
  targets:
  - select:
      group: cert-manager.io
      version: v1
      kind: Certificate
      name: webhook-certificate
      namespace: system
    fieldPaths:
    - spec.dnsNames.0
    - spec.dnsNames.1
    options:
      delimiter: .
      index: 1
- source: # replaces SERVICE_NAME with namespace of the service
    kind: Service
    version: v1
    name: webhook-service
    fieldPath: metadata.name
  targets:
  - select:
      group: cert-manager.io
      version: v1
      kind: Certificate
      name: webhook-certificate
      namespace: system
    fieldPaths:
    - spec.dnsNames.0
    - spec.dnsNames.1
    options:
      delimiter: .
      index: 0
